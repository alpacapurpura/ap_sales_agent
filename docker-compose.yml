services:
  # --- Application Service ---
  app:
    build: .
    container_name: visionarias_brain
    restart: unless-stopped
    env_file:
      - .env
    volumes:
      - .:/app
    depends_on:
      - redis
      - qdrant
      - postgres
    networks:
      - internal_net
      - gateway  # Dynamic Gateway Network
    profiles: ["development", "production"]
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=${TRAEFIK_NETWORK}"
      # Router for HTTPS (API)
      - "traefik.http.routers.visionarias.rule=Host(`${API_DOMAIN}`)"
      - "traefik.http.routers.visionarias.entrypoints=websecure"
      - "traefik.http.routers.visionarias.tls.certresolver=myresolver"
      # Service definition
      - "traefik.http.services.visionarias.loadbalancer.server.port=8000"

  # --- Admin Interface ---
  admin:
    build: .
    container_name: visionarias_admin
    restart: unless-stopped
    command: streamlit run src/admin/app.py --server.port 8501 --server.address 0.0.0.0 --browser.gatherUsageStats false --server.enableCORS false --server.enableXsrfProtection false --server.maxUploadSize 500
    volumes:
      - .:/app
    env_file:
      - .env
    depends_on:
      - qdrant
    networks:
      - internal_net
      - gateway
    ports:
      - "127.0.0.1:8501:8501" # Localhost only, let Traefik handle external
    profiles: ["development", "production"]
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=${TRAEFIK_NETWORK}"
      - "traefik.http.routers.admin.rule=Host(`${DASHBOARD_DOMAIN}`)"
      - "traefik.http.routers.admin.entrypoints=websecure"
      - "traefik.http.routers.admin.tls.certresolver=myresolver"
      - "traefik.http.services.admin.loadbalancer.server.port=8501"
      # Basic Auth could be added here for security

  # --- Infrastructure Services ---
  redis:
    image: redis:7-alpine
    container_name: visionarias_redis
    restart: always
    command: redis-server --appendonly yes
    volumes:
      - ./data/redis_data:/data
    networks:
      - internal_net
    profiles: ["development", "production"]
    ports:
      - "127.0.0.1:6379:6379" # Secure binding

  qdrant:
    image: qdrant/qdrant:v1.7.3
    container_name: visionarias_qdrant
    restart: always
    volumes:
      - ./data/qdrant_data:/qdrant/storage
    networks:
      - internal_net
    profiles: ["development", "production"]
    ports:
      - "127.0.0.1:6333:6333" # Secure binding
      - "127.0.0.1:6334:6334"

  postgres:
    image: postgres:15-alpine
    container_name: visionarias_postgres
    restart: always
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    volumes:
      - ./data/postgres_data:/var/lib/postgresql/data
    networks:
      - internal_net
    profiles: ["development", "production"]
    ports:
      - "127.0.0.1:5432:5432" # Secure binding

  # --- Cloudflare Tunnel (Dev only usually, or Prod if no external Traefik) ---
  tunnel:
    image: cloudflare/cloudflared:latest
    container_name: cloudflare-tunnel
    restart: unless-stopped
    command: tunnel run
    volumes:
      # Mount the credentials file (Absolute path as requested by user instructions)
      - /home/chris/.cloudflared/cert.json:/etc/cloudflared/cert.json:ro
      # Mount the config file we just created
      - ./cloudflare/config.yml:/etc/cloudflared/config.yml:ro
    networks:
      - gateway # Connects to the same network as Traefik (web_gateway_local in dev)
    profiles: ["development"] # Typically for dev testing or specific deployments
    # depends_on:
    #   - traefik # Removed because Traefik is external in this setup


networks:
  internal_net:
    driver: bridge
  gateway:
    name: ${TRAEFIK_NETWORK}
    external: true

# volumes:
#   redis_data:
#   qdrant_data:
#   postgres_data:
